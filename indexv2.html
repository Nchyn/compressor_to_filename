<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>图片压缩工具（拖拽 + 批量覆盖 + 文件夹）-v1629</title>
<style>
  :root {
    --bg-color: #ffffff;
    --text-color: #000000;
    --input-bg: #f0f0f0;
    --input-border: #ccc;
    --button-bg: #007bff;
    --button-color: #fff;
  }
  [data-theme="dark"] {
    --bg-color: #1e1e1e;
    --text-color: #f0f0f0;
    --input-bg: #333;
    --input-border: #555;
    --button-bg: #0d6efd;
    --button-color: #fff;
  }
  body {
    background: var(--bg-color);
    color: var(--text-color);
    font-family: sans-serif;
    margin: 0;
    padding: 1rem;
  }
  .input-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }
  input[type="number"] {
    width: 80px;
    padding: 0.2rem 0.4rem;
    border: 1px solid var(--input-border);
    background: var(--input-bg);
    color: var(--text-color);
  }
  button {
    padding: 0.5rem 1rem;
    border: none;
    background: var(--button-bg);
    color: var(--button-color);
    cursor: pointer;
  }
  .theme-toggle {
    position: fixed;
    top: 1rem;
    right: 1rem;
  }
  #installPrompt {
    display: none;
    padding: 1rem;
    background: #fffae6;
    border: 1px solid #ffd700;
    margin-bottom: 1rem;
  }
  #dropZone {
    border: 2px dashed var(--input-border);
    padding: 2rem;
    text-align: center;
    margin-bottom: 1rem;
    cursor: pointer;
  }
  #dropZone.dragover {
    border-color: var(--button-bg);
    background: rgba(0, 123, 255, 0.05);
  }
</style>
</head>
<body>
<div id="installPrompt">
  你可以将此工具安装为应用：<button id="installBtn">安装</button>
</div>

<h1>图片压缩工具</h1>

<div class="input-group">
  <label>
    <input type="checkbox" id="forceUseDefault" />
    手动设置大小
  </label>
  <label id="defaultSizeGroup" style="display:none;">
    默认压缩目标大小（KB）：
    <input type="number" id="defaultSizeInput" value="160" min="1" />
  </label>
</div>

<div id="dropZone">拖拽图片/文件夹到这里或点击选择文件</div>
<div class="input-group">
  <button id="selectFilesBtn">选择图片</button>
</div>

<button class="theme-toggle" id="themeToggle">切换深色模式</button>

<script>
  const themeToggle = document.getElementById('themeToggle');
  themeToggle.addEventListener('click', () => {
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', theme);
  });

  const forceCheckbox = document.getElementById('forceUseDefault');
  const defaultSizeGroup = document.getElementById('defaultSizeGroup');
  forceCheckbox.addEventListener('change', () => {
    defaultSizeGroup.style.display = forceCheckbox.checked ? 'inline-flex' : 'none';
  });

  // PWA安装提示
  let deferredPrompt;
  const installPromptDiv = document.getElementById('installPrompt');
  const installBtn = document.getElementById('installBtn');
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installPromptDiv.style.display = 'block';
  });
  installBtn.addEventListener('click', async () => {
    installPromptDiv.style.display = 'none';
    if (deferredPrompt) {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(() => deferredPrompt = null);
    }
  });

  // 压缩单个文件
  async function compressFile(fileHandle) {
    const file = await fileHandle.getFile();
    const img = new Image();
    const blob = await fileHandle.getFile();
    const url = URL.createObjectURL(blob);
    img.src = url;

    await new Promise(resolve => img.onload = resolve);

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);

    let quality = 0.92;
    if (forceCheckbox.checked) {
      const targetKB = Number(document.getElementById('defaultSizeInput').value);
      const factor = targetKB * 1024 / blob.size;
      quality = Math.min(Math.max(factor, 0.1), 0.92);
    }

    const compressedBlob = await new Promise(res => canvas.toBlob(res, file.type, quality));
    const writable = await fileHandle.createWritable();
    await writable.write(compressedBlob);
    await writable.close();
    URL.revokeObjectURL(url);
  }

  // 批量压缩
  async function compressFiles(fileHandles) {
    if (fileHandles.length > 100) {
      const ok = confirm(`你选择了 ${fileHandles.length} 个文件，继续压缩吗？`);
      if (!ok) return;
    }
    for (const fileHandle of fileHandles) {
      await compressFile(fileHandle);
    }
    alert(`批量压缩完成，共处理 ${fileHandles.length} 个文件`);
  }

  // 递归遍历文件夹
  async function getFilesFromEntry(entry) {
    const files = [];
    if (entry.isFile) {
      const handle = await entry.getFileSystemHandle?.() || entry;
      files.push(handle);
    } else if (entry.isDirectory) {
      for await (const handle of entry.values()) {
        const subFiles = await getFilesFromEntry(handle);
        files.push(...subFiles);
      }
    }
    return files;
  }

  // 拖拽处理
  const dropZone = document.getElementById('dropZone');
  dropZone.addEventListener('click', () => selectFilesBtn.click());

  dropZone.addEventListener('dragover', e => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });
  dropZone.addEventListener('dragleave', e => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
  });
  dropZone.addEventListener('drop', async e => {
    e.preventDefault();
    dropZone.classList.remove('dragover');

    const items = e.dataTransfer.items;
    const fileHandles = [];
    for (let i = 0; i < items.length; i++) {
      const entry = items[i].webkitGetAsEntry();
      if (entry) {
        const handles = await getFilesFromEntry(entry);
        fileHandles.push(...handles);
      }
    }
    if (fileHandles.length > 0) {
      await compressFiles(fileHandles);
    }
  });

  // 按钮选择文件
  const selectFilesBtn = document.getElementById('selectFilesBtn');
  selectFilesBtn.addEventListener('click', async () => {
    try {
      const fileHandles = await window.showOpenFilePicker({
        multiple: true,
        types: [{ description: '图片', accept: { 'image/*': ['.png', '.jpg', '.jpeg', '.webp'] } }]
      });
      if (fileHandles.length > 0) {
        await compressFiles(fileHandles);
      }
    } catch (err) {
      console.error(err);
      alert('操作取消或出错');
    }
  });
</script>
</body>
</html>
