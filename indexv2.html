<!DOCTYPE html>
<html lang="zh" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ‰¹é‡å›¾ç‰‡å‹ç¼©å™¨</title>
  <style>
    :root {
      --bg-light: #fff;
      --text-light: #000;
      --bg-dark: #121212;
      --text-dark: #f0f0f0;
      --primary-color: #007bff;
      --primary-hover: #0069d9;
    }
    html[data-theme='dark'] { background: var(--bg-dark); color: var(--text-dark); }
    html[data-theme='light'] { background: var(--bg-light); color: var(--text-light); }
    body { font-family: sans-serif; padding: 2em; max-width: 900px; margin: auto; }
    #dropZone { border: 2px dashed #ccc; padding: 2em; text-align: center; margin-bottom: 1em; border-radius: 10px; background: #f9f9f9; cursor: pointer; }
    #dropZone.dragover, #dropZone:hover { background-color: #e0f7ff; border-color: var(--primary-color); }
    .image-row { display: flex; align-items: center; gap: 1em; padding: 1em; margin-bottom: 1em; border: 1px solid #ccc; border-radius: 8px; }
    .image-col { flex: 1; }
    .info-col { flex: 2; }
    .file-name { font-weight: bold; word-break: break-all; margin-bottom: 0.5em; }
    .size-info { margin-bottom: 0.5em; line-height: 1.5; }
    .image-preview { max-width: 150px; max-height: 120px; cursor: pointer; }
    #themeToggle { float: right; cursor: pointer; background: none; border: none; font-size: 1.2em; }
    #chooseDirBtn { margin: 1em 0; padding: 0.5em 1em; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>ğŸ“¦ å›¾ç‰‡å‹ç¼©å™¨ <button id="themeToggle">ğŸŒ“</button></h2>
  <p>è¯·æ‹–å…¥åŒ…å«å¤§å°å‚æ•°çš„å›¾ç‰‡æ–‡ä»¶ï¼Œå¦‚ xxx-160KB.jpg</p>
  
  <button id="chooseDirBtn">ğŸ“ é€‰æ‹©ä¿å­˜ç›®å½•</button>

  <div class="input-group">
    <label><input type="checkbox" id="forceUseDefault"> æ‰‹åŠ¨è®¾ç½®</label>
    <input type="number" id="defaultSizeInput" value="160" min="1" style="width:6em; display:none;"> KB
    <label><input type="checkbox" id="removeParamCheckbox"> åˆ é™¤æ–‡ä»¶åå‚æ•°</label>
  </div>

  <div id="dropZone">ğŸ“‚ ç‚¹å‡»æˆ–å°†å›¾ç‰‡ / æ–‡ä»¶å¤¹æ‹–æ‹½åˆ°æ­¤åŒºåŸŸ</div>
  <input type="file" id="fileInput" accept="image/*" multiple webkitdirectory style="display:none;" />
  
  <div id="output"></div>

<script>
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const output = document.getElementById('output');
const defaultSizeInput = document.getElementById('defaultSizeInput');
const forceUseDefault = document.getElementById('forceUseDefault');
const removeParamCheckbox = document.getElementById('removeParamCheckbox');
const themeToggle = document.getElementById('themeToggle');
const chooseDirBtn = document.getElementById('chooseDirBtn');

let rootDirHandle = null;

async function requestDirectoryAccess() {
  try {
    rootDirHandle = await window.showDirectoryPicker();
    alert("å·²æˆæƒç›®å½•ï¼š" + rootDirHandle.name);
  } catch (e) {
    console.log("ç›®å½•æˆæƒå–æ¶ˆ", e);
  }
}
chooseDirBtn.addEventListener('click', requestDirectoryAccess);

forceUseDefault.addEventListener('change', () => {
  defaultSizeInput.style.display = forceUseDefault.checked ? 'inline-block' : 'none';
});

function getTargetSizeFromName(name) {
  const fallback = parseInt(defaultSizeInput.value);
  if (forceUseDefault.checked) return fallback * 1000;
  const match = name.match(/-(\d+)KB/i);
  return match ? parseInt(match[1]) * 1000 : fallback * 1000;
}

function getCleanFileName(name) {
  return name.replace(/-\d+KB/i, '');
}

function dataURLToBlob(dataURL) {
  const [header, base64] = dataURL.split(',');
  const mime = header.match(/:(.*?);/)[1];
  const binary = atob(base64);
  const array = Uint8Array.from(binary, c => c.charCodeAt(0));
  return new Blob([array], { type: mime });
}

async function compressImageToTarget(file, targetSize) {
  const img = new Image();
  const reader = new FileReader();
  reader.readAsDataURL(file);
  await new Promise(resolve => { reader.onload = () => { img.src = reader.result; img.onload = resolve; }; });
  const canvas = document.createElement('canvas');
  canvas.width = img.width; canvas.height = img.height;
  const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0);

  let low = 0.1, high = 1.0, resultBlob = null;
  for (let i = 0; i < 10; i++) {
    const mid = (low + high) / 2;
    const dataUrl = canvas.toDataURL('image/jpeg', mid);
    const blob = dataURLToBlob(dataUrl);
    if (blob.size <= targetSize) { resultBlob = blob; low = mid; } else { high = mid; }
  }
  return resultBlob;
}

async function saveFileToDirectory(fileName, blob) {
  if (!rootDirHandle) {
    await requestDirectoryAccess();
    if (!rootDirHandle) return; // ç”¨æˆ·å–æ¶ˆ
  }
  const cleanName = removeParamCheckbox.checked ? getCleanFileName(fileName) : fileName;
  const fileHandle = await rootDirHandle.getFileHandle(cleanName, { create: true });
  const writable = await fileHandle.createWritable();
  await writable.write(blob);
  await writable.close();
}

async function handleFiles(files) {
  for (const file of files) {
    const row = document.createElement('div'); row.className = 'image-row'; output.appendChild(row);
    const originalCol = document.createElement('div'); originalCol.className = 'image-col'; row.appendChild(originalCol);
    const infoCol = document.createElement('div'); infoCol.className = 'info-col'; row.appendChild(infoCol);

    const fileName = document.createElement('div'); fileName.className = 'file-name'; fileName.textContent = file.name;
    infoCol.appendChild(fileName);

    const targetSize = getTargetSizeFromName(file.name);
    const originalSizeKB = (file.size / 1024).toFixed(1);
    if (file.size <= targetSize) {
      infoCol.innerHTML += `<div class="size-info">åŸå§‹å¤§å°: ${originalSizeKB}KBï¼ˆå°äºç›®æ ‡ï¼Œè·³è¿‡å‹ç¼©ï¼‰</div>`;
      await saveFileToDirectory(file.name, file);
      continue;
    }

    const compressed = await compressImageToTarget(file, targetSize);
    if (compressed) {
      const compressedSizeKB = (compressed.size / 1024).toFixed(1);
      const ratio = ((1 - compressed.size / file.size) * 100).toFixed(1);
      infoCol.innerHTML += `<div class="size-info">åŸå§‹: ${originalSizeKB}KB<br>å‹ç¼©: ${compressedSizeKB}KB<br>å‹ç¼©ç‡: ${ratio}%</div>`;
      await saveFileToDirectory(file.name, compressed);
    } else {
      infoCol.innerHTML += `<div class="size-info">âŒ å‹ç¼©å¤±è´¥</div>`;
    }
  }
}

// æ‹–æ‹½æ–‡ä»¶/æ–‡ä»¶å¤¹
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
  e.preventDefault(); dropZone.classList.remove('dragover');
  const items = e.dataTransfer.items;
  for (const item of items) {
    const entry = item.webkitGetAsEntry();
    if (entry) {
      if (entry.isDirectory) {
        if (confirm(`æ£€æµ‹åˆ°æ–‡ä»¶å¤¹ã€Œ${entry.name}ã€ï¼Œæ˜¯å¦æ‰¹é‡å¤„ç†ï¼Ÿ`)) {
          traverseFileTree(entry);
        }
      } else {
        const file = item.getAsFile();
        handleFiles([file]);
      }
    }
  }
});
dropZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', () => handleFiles(Array.from(fileInput.files)));

function traverseFileTree(entry) {
  if (entry.isFile) {
    entry.file(file => { handleFiles([file]); });
  } else if (entry.isDirectory) {
    const reader = entry.createReader();
    reader.readEntries(entries => { entries.forEach(ent => traverseFileTree(ent)); });
  }
}

// ä¸»é¢˜åˆ‡æ¢
themeToggle.addEventListener('click', () => {
  const html = document.documentElement;
  html.dataset.theme = html.dataset.theme === 'dark' ? 'light' : 'dark';
  localStorage.setItem('theme', html.dataset.theme);
});
if (localStorage.getItem('theme')) {
  document.documentElement.dataset.theme = localStorage.getItem('theme');
}
</script>
</body>
</html>
