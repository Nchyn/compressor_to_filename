<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>图片压缩工具</title>
<link rel="manifest" href="manifest.json">
<style>
  :root {
    --bg-color: #f0f0f0;
    --text-color: #000;
    --input-bg: #fff;
    --input-border: #ccc;
    --button-bg: #007bff;
    --button-color: #fff;
  }
  [data-theme="dark"] {
    --bg-color: #181818;
    --text-color: #f0f0f0;
    --input-bg: #282828;
    --input-border: #555;
    --button-bg: #0d6efd;
    --button-color: #fff;
  }
  body {
    margin: 0;
    font-family: sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
  }
  .input-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
    flex-wrap: wrap;
  }
  input[type="number"] {
    width: 100px;
    padding: 5px;
    border: 1px solid var(--input-border);
    background: var(--input-bg);
    color: var(--text-color);
  }
  button {
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    background-color: var(--button-bg);
    color: var(--button-color);
    cursor: pointer;
  }
  #dropZone {
    width: 100%;
    max-width: 600px;
    height: 200px;
    border: 2px dashed var(--input-border);
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    margin-bottom: 20px;
    transition: background 0.3s;
  }
  #dropZone.dragover {
    background: rgba(0,0,0,0.1);
  }
  #pwaPrompt {
    position: fixed;
    bottom: 20px;
    background: var(--button-bg);
    color: var(--button-color);
    padding: 10px 20px;
    border-radius: 8px;
    display: none;
    cursor: pointer;
  }
</style>
</head>
<body>
<h1>图片压缩工具v1638</h1>

<div class="input-group">
  <label for="forceUseDefault">
    <input type="checkbox" id="forceUseDefault" />
    手动设置大小
  </label>
  <input type="number" id="defaultSizeInput" value="160" min="1" style="display:none;" />
</div>

<div class="input-group">
  <button id="chooseFolder">选择文件夹处理图片</button>
  <button id="themeToggle">切换深色模式</button>
</div>

<div id="dropZone">拖拽文件夹到这里</div>

<div id="pwaPrompt">点击安装应用</div>

<script>
let deferredPrompt;
const forceCheckbox = document.getElementById('forceUseDefault');
const sizeInput = document.getElementById('defaultSizeInput');

forceCheckbox.addEventListener('change', () => {
  sizeInput.style.display = forceCheckbox.checked ? 'inline-block' : 'none';
});

// PWA
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('pwaPrompt').style.display = 'block';
});
document.getElementById('pwaPrompt').addEventListener('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(() => { deferredPrompt = null; });
    document.getElementById('pwaPrompt').style.display = 'none';
  }
});

// 深色模式切换
document.getElementById('themeToggle').addEventListener('click', () => {
  const current = document.documentElement.getAttribute('data-theme');
  document.documentElement.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
});

// 工具函数
async function compressImage(fileHandle, targetKB) {
  const file = await fileHandle.getFile();
  const bitmap = await createImageBitmap(file);
  const canvas = document.createElement('canvas');
  canvas.width = bitmap.width;
  canvas.height = bitmap.height;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(bitmap, 0, 0);
  let quality = 0.92;
  let blob;
  do {
    blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', quality));
    quality -= 0.05;
  } while(blob.size / 1024 > targetKB && quality > 0.1);
  const writable = await fileHandle.createWritable();
  await writable.write(blob);
  await writable.close();
}

// 遍历文件夹
async function* getFilesRecursively(dirHandle) {
  for await (const entry of dirHandle.values()) {
    if (entry.kind === 'file') {
      if (entry.name.match(/\.(jpe?g|png)$/i)) yield entry;
    } else if (entry.kind === 'directory') {
      yield* getFilesRecursively(entry);
    }
  }
}

// 批量处理
async function processFolder(dirHandle) {
  const targetKB = forceCheckbox.checked ? parseInt(sizeInput.value) : 160;
  const files = [];
  for await (const file of getFilesRecursively(dirHandle)) {
    files.push(file);
  }
  if (files.length === 0) {
    alert('没有找到图片文件！');
    return;
  }
  if (files.length > 100) {
    if (!confirm(`检测到 ${files.length} 个图片文件，确定继续吗？`)) return;
  }
  for (const fileHandle of files) {
    await compressImage(fileHandle, targetKB);
  }
  alert(`已压缩 ${files.length} 张图片`);
}

// 选择文件夹按钮
document.getElementById('chooseFolder').addEventListener('click', async () => {
  try {
    const folderHandle = await window.showDirectoryPicker();
    await processFolder(folderHandle);
  } catch (err) {
    console.error(err);
  }
});

// 拖拽
const dropZone = document.getElementById('dropZone');
dropZone.addEventListener('dragover', e => {
  e.preventDefault();
  dropZone.classList.add('dragover');
});
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', async (e) => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  const items = e.dataTransfer.items;
  if (items.length === 0) return;
  for (const item of items) {
    if (item.kind === 'file' && item.webkitGetAsEntry) {
      const entry = item.webkitGetAsEntry();
      if (entry.isDirectory) {
        const folderHandle = await window.showDirectoryPicker();
        await processFolder(folderHandle);
        break; // 只处理第一个文件夹
      }
    }
  }
});
</script>
</body>
</html>
