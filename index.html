<!DOCTYPE html>
<html lang="zh" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="data:image/gif;base64,R0lGODlhEAAQAIABAP8AAP///yH5BAEAAAEALAAAAAAQABAAAAIgjI+py+0PTgygTolpNvN6FF1alZBeB2bf1lnPC8fybBQAOw==" type="image/gif">
  <title>批量图片压缩器</title>
  <style>
    :root {
      --bg-light: #fff;
      --text-light: #000;
      --bg-dark: #121212;
      --text-dark: #f0f0f0;
    }

    html[data-theme='dark'] {
      background-color: var(--bg-dark);
      color: var(--text-dark);
    }

    html[data-theme='light'] {
      background-color: var(--bg-light);
      color: var(--text-light);
    }

    body {
      font-family: sans-serif;
      padding: 2em;
      max-width: 700px;
      margin: auto;
      transition: background 0.3s, color 0.3s;
    }

    #dropZone {
      border: 2px dashed #ccc;
      padding: 2em;
      text-align: center;
      margin-bottom: 1em;
      border-radius: 10px;
      background: #f9f9f9;
      cursor: pointer;
      transition: background-color 0.3s, border-color 0.3s;
    }

    html[data-theme='dark'] #dropZone {
      background: #1f1f1f;
      border-color: #444;
    }

    #dropZone.dragover,
    #dropZone:hover {
      background-color: #e0f7ff;
      border-color: #007bff;
    }

    .image-block {
      margin: 1em 0;
      padding: 1em;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    .download-link {
      display: inline-block;
      margin-top: 0.5em;
      color: blue;
    }

    .image-preview {
      max-width: 200px;
      max-height: 150px;
      margin: 0.5em;
      cursor: pointer;
      vertical-align: middle;
    }

    .image-preview-enlarged {
      max-width: 90%;
      max-height: 90%;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      border: 3px solid #fff;
      background: #f0f0f0;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    .image-preview-enlarged-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 999;
    }

    .input-group {
      margin-bottom: 1em;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }

    .input-group label {
      font-weight: bold;
      white-space: nowrap;
    }

    .input-group input[type="number"] {
      flex: 1;
      padding: 0.5em;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .input-group input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 3px rgba(0,123,255,0.5);
    }

    #themeToggle {
      float: right;
    }

    #installContainer {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #007bff;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      cursor: pointer;
      display: none;
      z-index: 1000;
    }

    #installContainer:hover {
      background: #0069d9;
    }

    #removeParamCheckbox {
      margin-left: 1em;
    }
  </style>
</head>
<body>
  <h2>📦 图片压缩器 <button id="themeToggle">🌓</button></h2>
  <p>请拖入包含大小参数的图片文件，如 xxx-160KB.jpg</p>

  <div class="input-group" style="display: flex; align-items: center; gap: 1em;">
    <label for="removeParamCheckbox" style="display: flex; align-items: center; gap: 0.4em; white-space: nowrap;">
      <input type="checkbox" id="removeParamCheckbox" />
      删除文件名中的参数
    </label>
    <label for="forceUseDefault" style="display: flex; align-items: center; gap: 0.4em; white-space: nowrap;">
      <input type="checkbox" id="forceUseDefault" />
      手动设置
    </label>
  
    <div id="defaultSizeGroup" style="display: none; display: flex; align-items: center; gap: 0.5em;">
      <label for="defaultSizeInput">目标（KB）：</label>
      <input type="number" id="defaultSizeInput" value="160" min="1" style="width: 6em;" />
    </div>
  </div>

  <div id="dropZone">📂 点击或将图片拖拽到此区域</div>
  <input type="file" id="fileInput" accept="image/*" multiple style="display: none;" />
  <div id="output"></div>
  <div id="installContainer">⬇️ 安装应用</div>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const output = document.getElementById('output');
    const defaultSizeInput = document.getElementById('defaultSizeInput');
    const forceUseDefault = document.getElementById('forceUseDefault');
    const defaultSizeGroup = document.getElementById('defaultSizeGroup');
    const themeToggle = document.getElementById('themeToggle');
    const removeParamCheckbox = document.getElementById('removeParamCheckbox');
    const installContainer = document.getElementById('installContainer');
    const zip = new JSZip();
    let deferredPrompt = null;

    function updateDefaultSizeVisibility() {
      defaultSizeGroup.style.display = forceUseDefault.checked ? 'flex' : 'none';
    }

    forceUseDefault.addEventListener('change', updateDefaultSizeVisibility);
    updateDefaultSizeVisibility();

    function getTargetSizeFromName(name) {
      const fallback = parseInt(defaultSizeInput.value);
      const force = forceUseDefault.checked;
      if (force) return fallback > 0 ? fallback * 1024 : null;

      // 改进后的正则表达式，匹配文件名中任意位置的 -160KB 模式
      const match = name.match(/-(\d+)KB/i);
      if (match) return parseInt(match[1]) * 1024;
      return fallback > 0 ? fallback * 1024 : null;
    }

    function getCleanFileName(name) {
      // 删除文件名中的 -160KB 参数
      return name.replace(/-\d+KB/i, '');
    }

    function dataURLToBlob(dataURL) {
      const [header, base64] = dataURL.split(',');
      const mime = header.match(/:(.*?);/)[1];
      const binary = atob(base64);
      const array = Uint8Array.from(binary, char => char.charCodeAt(0));
      return new Blob([array], { type: mime });
    }

    async function compressImageToTarget(file, targetSize) {
      const img = new Image();
      const reader = new FileReader();
      reader.readAsDataURL(file);

      await new Promise(resolve => {
        reader.onload = () => {
          img.src = reader.result;
          img.onload = resolve;
        };
      });

      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);

      let low = 0.1, high = 1.0;
      let resultBlob = null;

      for (let i = 0; i < 10; i++) {
        const mid = (low + high) / 2;
        const dataUrl = canvas.toDataURL('image/jpeg', mid);
        const blob = dataURLToBlob(dataUrl);
        if (blob.size <= targetSize) {
          resultBlob = blob;
          low = mid;
        } else {
          high = mid;
        }
      }

      return resultBlob;
    }

    function createDownloadLink(blob, name) {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = removeParamCheckbox.checked ? getCleanFileName(name) : name;
      link.textContent = '📥 下载图像';
      link.className = 'download-link';
      return link;
    }

    async function handleFiles(files) {
      output.innerHTML = '';
      zip.files = {};
      let anyProcessed = false;

      for (const file of files) {
        const block = document.createElement('div');
        block.className = 'image-block';
        output.appendChild(block);

        const title = document.createElement('h4');
        title.textContent = `🖼️ 处理文件：${file.name}`;
        block.appendChild(title);

        const targetSize = getTargetSizeFromName(file.name);
        if (!targetSize || isNaN(targetSize)) {
          const warn = document.createElement('p');
          warn.textContent = '❌ 未能确定目标大小（请检查文件名或输入框）';
          block.appendChild(warn);
          continue;
        }

        if (file.size <= targetSize) {
          const info = document.createElement('p');
          info.textContent = `✅ 原始图片 ${(file.size / 1024).toFixed(1)}KB 小于目标，跳过压缩`;
          block.appendChild(info);

          const preview = document.createElement('img');
          preview.className = 'image-preview';
          preview.src = URL.createObjectURL(file);
          preview.dataset.previewType = 'original';
          preview.dataset.original = preview.src;
          block.appendChild(preview);

          const arrayBuffer = await file.arrayBuffer();
          zip.file(removeParamCheckbox.checked ? getCleanFileName(file.name) : file.name, arrayBuffer);
          block.appendChild(createDownloadLink(file, file.name));
          continue;
        }

        const compressed = await compressImageToTarget(file, targetSize);
        if (compressed) {
          anyProcessed = true;

          const previewOriginal = document.createElement('img');
          previewOriginal.className = 'image-preview';
          previewOriginal.src = URL.createObjectURL(file);
          previewOriginal.dataset.previewType = 'original';
          previewOriginal.dataset.original = previewOriginal.src;
          previewOriginal.dataset.compressed = URL.createObjectURL(compressed);
          block.appendChild(previewOriginal);

          const previewCompressed = document.createElement('img');
          previewCompressed.className = 'image-preview';
          previewCompressed.src = previewOriginal.dataset.compressed;
          previewCompressed.dataset.previewType = 'compressed';
          previewCompressed.dataset.original = previewOriginal.src;
          previewCompressed.dataset.compressed = previewCompressed.src;
          block.appendChild(previewCompressed);

          block.appendChild(createDownloadLink(compressed, file.name));
          const arrayBuffer = await compressed.arrayBuffer();
          zip.file(removeParamCheckbox.checked ? getCleanFileName(file.name) : file.name, arrayBuffer);
        } else {
          const fail = document.createElement('p');
          fail.textContent = '❌ 压缩失败';
          block.appendChild(fail);
        }
      }

      if (anyProcessed) {
        const now = new Date();
        const zipName = `compressed_${now.toISOString().slice(0,19).replace(/[:T]/g,'-')}.zip`;
        const content = await zip.generateAsync({ type: "blob" });
        saveAs(content, zipName);
      }
    }

    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      handleFiles(Array.from(e.dataTransfer.files));
    });
    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
      handleFiles(Array.from(fileInput.files));
    });

    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('image-preview')) {
        const original = e.target.dataset.original;
        const compressed = e.target.dataset.compressed;
        const overlay = document.createElement('div');
        overlay.className = 'image-preview-enlarged-overlay';

        const enlarged = document.createElement('img');
        enlarged.src = e.target.src;
        enlarged.className = 'image-preview-enlarged';
        enlarged.dataset.original = original;
        enlarged.dataset.compressed = compressed;
        enlarged.dataset.state = e.target.dataset.previewType;

        enlarged.addEventListener('click', ev => {
          ev.stopPropagation();
          enlarged.src = enlarged.dataset.state === 'original' ? compressed : original;
          enlarged.dataset.state = enlarged.dataset.state === 'original' ? 'compressed' : 'original';
        });

        overlay.addEventListener('click', () => {
          overlay.remove();
          enlarged.remove();
        });

        document.body.appendChild(overlay);
        document.body.appendChild(enlarged);
      }
    });

    // 主题切换逻辑
    themeToggle.addEventListener('click', () => {
      const html = document.documentElement;
      html.dataset.theme = html.dataset.theme === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', html.dataset.theme);
    });

    // 初始化主题
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      document.documentElement.dataset.theme = savedTheme;
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.dataset.theme = 'dark';
    }

    // PWA 安装提示
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installContainer.style.display = 'block';
    });

    installContainer.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') {
        installContainer.style.display = 'none';
      }
      deferredPrompt = null;
    });

    // 注册 Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
  </script>
</body>
</html>
