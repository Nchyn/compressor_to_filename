<!DOCTYPE html>
<html lang="zh" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="data:image/gif;base64,R0lGODlhEAAQAIABAP8AAP///yH5BAEAAAEALAAAAAAQABAAAAIgjI+py+0PTgygTolpNvN6FF1alZBeB2bf1lnPC8fybBQAOw==" type="image/gif">
  <title>æ‰¹é‡å›¾ç‰‡å‹ç¼©å™¨</title>
  <style>
    :root {
      --bg-light: #fff;
      --text-light: #000;
      --bg-dark: #121212;
      --text-dark: #f0f0f0;
      --primary-color: #007bff;
      --primary-hover: #0069d9;
    }

    html[data-theme='dark'] {
      background-color: var(--bg-dark);
      color: var(--text-dark);
    }

    html[data-theme='light'] {
      background-color: var(--bg-light);
      color: var(--text-light);
    }

    body {
      font-family: sans-serif;
      padding: 2em;
      max-width: 900px;
      margin: auto;
      transition: background 0.3s, color 0.3s;
    }

    #dropZone {
      border: 2px dashed #ccc;
      padding: 2em;
      text-align: center;
      margin-bottom: 1em;
      border-radius: 10px;
      background: #f9f9f9;
      cursor: pointer;
      transition: background-color 0.3s, border-color 0.3s;
    }

    html[data-theme='dark'] #dropZone {
      background: #1f1f1f;
      border-color: #444;
    }

    #dropZone.dragover,
    #dropZone:hover {
      background-color: #e0f7ff;
      border-color: var(--primary-color);
    }

    html[data-theme='dark'] #dropZone.dragover,
    html[data-theme='dark'] #dropZone:hover {
      background-color: #2a3a4a;
      border-color: var(--primary-color);
    }

    .output-container {
      margin-top: 1em;
    }

    .image-row {
      display: flex;
      align-items: center;
      gap: 1em;
      padding: 1em;
      margin-bottom: 1em;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    html[data-theme='dark'] .image-row {
      border-color: #444;
      background-color: #1f1f1f;
    }

    .image-col {
      flex: 1;
      min-width: 0;
    }

    .image-preview {
      max-width: 150px;
      max-height: 120px;
      display: block;
      cursor: pointer;
    }

    .info-col {
      flex: 2;
      min-width: 0;
    }

    .file-name {
      font-weight: bold;
      word-break: break-all;
      margin-bottom: 0.5em;
    }

    .size-info {
      margin-bottom: 0.5em;
      line-height: 1.5;
    }

    .download-link {
      display: inline-block;
      padding: 0.5em 1em;
      background-color: var(--primary-color);
      color: white;
      text-decoration: none;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    .download-link:hover {
      background-color: var(--primary-hover);
    }

    .image-preview-enlarged {
      max-width: 90%;
      max-height: 90%;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      border: 3px solid #fff;
      background: #f0f0f0;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    .image-preview-enlarged-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 999;
    }

    .input-group {
      margin-bottom: 1em;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }

    .input-group label {
      font-weight: bold;
      white-space: nowrap;
    }

    .input-group input[type="number"] {
      flex: 1;
      padding: 0.5em;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    html[data-theme='dark'] .input-group input[type="number"] {
      background-color: #2a2a2a;
      border-color: #444;
      color: var(--text-dark);
    }

    .input-group input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 3px rgba(0,123,255,0.5);
    }

    #themeToggle {
      float: right;
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      color: inherit;
    }

    /* é€šçŸ¥æç¤ºæ ·å¼ */
    .notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 15px 20px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      z-index: 1000;
      display: none;
      max-width: 90%;
      text-align: center;
    }

    .notification.show {
      display: block;
      animation: fadeInUp 0.3s;
    }

    .notification.hide {
      animation: fadeOutDown 0.3s;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    @keyframes fadeOutDown {
      from {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
      to {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
    }

    /* å®‰è£…æç¤ºæ ·å¼ */
    .pwa-install-prompt {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 1em;
      z-index: 1000;
      display: none;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
    }

    .pwa-install-content {
      max-width: 700px;
      margin: 0 auto;
    }

    .pwa-install-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 1em;
      margin-top: 1em;
    }

    .pwa-install-buttons button {
      padding: 0.5em 1em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #installConfirm {
      background: var(--primary-color);
      color: white;
    }

    #installCancel {
      background: #666;
      color: white;
    }

    /* æ›´æ–°æç¤ºæ ·å¼ */
    .pwa-update-prompt {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--primary-color);
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
    }

    .pwa-update-content {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #updateRefresh {
      margin-top: 0.5em;
      background: white;
      color: var(--primary-color);
      border: none;
      padding: 0.3em 0.8em;
      border-radius: 4px;
      cursor: pointer;
    }

    #removeParamCheckbox {
      margin-left: 1em;
    }
  </style>
</head>
<body>
  <h2>ğŸ“¦ å›¾ç‰‡å‹ç¼©å™¨ <button id="themeToggle">ğŸŒ“</button></h2>
  <p>è¯·æ‹–å…¥åŒ…å«å¤§å°å‚æ•°çš„å›¾ç‰‡æ–‡ä»¶ï¼Œå¦‚ xxx-160KB.jpg</p>

  <div class="input-group" style="display: flex; align-items: center; gap: 1em;">
    <label for="forceUseDefault" style="display: flex; align-items: center; gap: 0.4em; white-space: nowrap;">
      <input type="checkbox" id="forceUseDefault" />
      æ‰‹åŠ¨è®¾ç½®
    </label>
  
    <div id="defaultSizeGroup" style="display: none; display: flex; align-items: center; gap: 0.5em;">
      <label for="defaultSizeInput">ç›®æ ‡ï¼ˆKBï¼‰ï¼š</label>
      <input type="number" id="defaultSizeInput" value="160" min="1" style="width: 6em;" />
    </div>

    <label for="removeParamCheckbox" style="display: flex; align-items: center; gap: 0.4em; white-space: nowrap;">
      <input type="checkbox" id="removeParamCheckbox" />
      åˆ é™¤æ–‡ä»¶åä¸­çš„å‚æ•°
    </label>
  </div>

  <div id="dropZone">ğŸ“‚ ç‚¹å‡»æˆ–å°†å›¾ç‰‡æ‹–æ‹½åˆ°æ­¤åŒºåŸŸ</div>
  <input type="file" id="fileInput" accept="image/*" multiple style="display: none;" />
  
  <div class="output-container" id="output">
    <!-- è¾“å‡ºå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
  </div>

  <!-- å‚æ•°æœªè¯†åˆ«æç¤º -->
  <div id="paramNotification" class="notification">
    <div id="notificationContent">æœªè¯†åˆ«åˆ°æ–‡ä»¶åä¸­çš„å¤§å°å‚æ•°ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼ <span id="defaultSizeValue">160</span>KB è¿›è¡Œå‹ç¼©</div>
    <button id="closeNotification" style="margin-top: 10px; background: #555; color: white; border: none; border-radius: 3px; padding: 5px 15px; cursor: pointer;">çŸ¥é“äº†</button>
  </div>

  <!-- PWA å®‰è£…æç¤º -->
  <div id="installContainer" class="pwa-install-prompt">
    <div class="pwa-install-content">
      <h4>å®‰è£…å›¾ç‰‡å‹ç¼©å™¨</h4>
      <p>æ·»åŠ åˆ°ä¸»å±å¹•ä»¥ä¾¿ç¦»çº¿ä½¿ç”¨</p>
      <div class="pwa-install-buttons">
        <button id="installCancel">ç¨å</button>
        <button id="installConfirm">å®‰è£…</button>
      </div>
    </div>
  </div>

  <!-- PWA æ›´æ–°æç¤º -->
  <div id="updateContainer" class="pwa-update-prompt">
    <div class="pwa-update-content">
      <h4>æ–°ç‰ˆæœ¬å¯ç”¨</h4>
      <p>æœ‰æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œè¯·åˆ·æ–°ä»¥è·å–æ›´æ–°</p>
      <button id="updateRefresh">åˆ·æ–°</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script>
    const APP_VERSION = '1.0.5'; // æ¯æ¬¡æ›´æ–°æ—¶ä¿®æ”¹ç‰ˆæœ¬å·
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const output = document.getElementById('output');
    const defaultSizeInput = document.getElementById('defaultSizeInput');
    const forceUseDefault = document.getElementById('forceUseDefault');
    const defaultSizeGroup = document.getElementById('defaultSizeGroup');
    const themeToggle = document.getElementById('themeToggle');
    const removeParamCheckbox = document.getElementById('removeParamCheckbox');
    const installContainer = document.getElementById('installContainer');
    const installConfirm = document.getElementById('installConfirm');
    const installCancel = document.getElementById('installCancel');
    const updateContainer = document.getElementById('updateContainer');
    const updateRefresh = document.getElementById('updateRefresh');
    const paramNotification = document.getElementById('paramNotification');
    const defaultSizeValue = document.getElementById('defaultSizeValue');
    const notificationContent = document.getElementById('notificationContent');
    const closeNotification = document.getElementById('closeNotification');
    const zip = new JSZip();
    let deferredPrompt = null;
    let hasShownNotification = false;
    let currentOverlay = null;
    let currentEnlarged = null;

    function updateDefaultSizeVisibility() {
      defaultSizeGroup.style.display = forceUseDefault.checked ? 'flex' : 'none';
    }

    forceUseDefault.addEventListener('change', updateDefaultSizeVisibility);
    updateDefaultSizeVisibility();

    function getTargetSizeFromName(name) {
      const fallback = parseInt(defaultSizeInput.value);
      const force = forceUseDefault.checked;
      if (force) return fallback > 0 ? fallback * 1024 : null;

      // æ”¹è¿›åçš„æ­£åˆ™è¡¨è¾¾å¼ï¼ŒåŒ¹é…æ–‡ä»¶åä¸­ä»»æ„ä½ç½®çš„ -160KB æ¨¡å¼
      const match = name.match(/-(\d+)KB/i);
      if (match) return parseInt(match[1]) * 1024;
      
      return fallback > 0 ? fallback * 1024 : null;
    }

    function showNotification(message) {
      notificationContent.innerHTML = message;
      paramNotification.classList.add('show');
      paramNotification.style.display = 'block';
      hasShownNotification = true;
      
      setTimeout(() => {
        paramNotification.classList.remove('show');
        paramNotification.classList.add('hide');
        setTimeout(() => {
          paramNotification.classList.remove('hide');
          paramNotification.style.display = 'none';
        }, 300);
      }, 5000);
    }

    closeNotification.addEventListener('click', () => {
      paramNotification.classList.remove('show');
      paramNotification.classList.add('hide');
      setTimeout(() => {
        paramNotification.classList.remove('hide');
        paramNotification.style.display = 'none';
      }, 300);
    });

    function getCleanFileName(name) {
      // åˆ é™¤æ–‡ä»¶åä¸­çš„ -160KB å‚æ•°
      return name.replace(/-\d+KB/i, '');
    }

    function dataURLToBlob(dataURL) {
      const [header, base64] = dataURL.split(',');
      const mime = header.match(/:(.*?);/)[1];
      const binary = atob(base64);
      const array = Uint8Array.from(binary, char => char.charCodeAt(0));
      return new Blob([array], { type: mime });
    }

    async function compressImageToTarget(file, targetSize) {
      const img = new Image();
      const reader = new FileReader();
      reader.readAsDataURL(file);

      await new Promise(resolve => {
        reader.onload = () => {
          img.src = reader.result;
          img.onload = resolve;
        };
      });

      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);

      let low = 0.1, high = 1.0;
      let resultBlob = null;

      for (let i = 0; i < 10; i++) {
        const mid = (low + high) / 2;
        const dataUrl = canvas.toDataURL('image/jpeg', mid);
        const blob = dataURLToBlob(dataUrl);
        if (blob.size <= targetSize) {
          resultBlob = blob;
          low = mid;
        } else {
          high = mid;
        }
      }

      return resultBlob;
    }

    function createDownloadLink(blob, name) {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = removeParamCheckbox.checked ? getCleanFileName(name) : name;
      link.textContent = 'ä¸‹è½½å›¾åƒ';
      link.className = 'download-link';
      return link;
    }

    function createPreviewImage(src, type, originalSrc, compressedSrc) {
      const img = document.createElement('img');
      img.className = 'image-preview';
      img.src = src;
      img.dataset.previewType = type;
      img.dataset.original = originalSrc;
      img.dataset.compressed = compressedSrc;
      return img;
    }

    function showEnlargedPreview(src, originalSrc, compressedSrc, type) {
      // ç§»é™¤ç°æœ‰çš„é¢„è§ˆ
      if (currentOverlay) currentOverlay.remove();
      if (currentEnlarged) currentEnlarged.remove();

      const overlay = document.createElement('div');
      overlay.className = 'image-preview-enlarged-overlay';
      currentOverlay = overlay;

      const enlarged = document.createElement('img');
      enlarged.src = src;
      enlarged.className = 'image-preview-enlarged';
      enlarged.dataset.original = originalSrc;
      enlarged.dataset.compressed = compressedSrc;
      enlarged.dataset.state = type;
      currentEnlarged = enlarged;

      // ç‚¹å‡»åˆ‡æ¢å›¾ç‰‡
      enlarged.addEventListener('click', (ev) => {
        ev.stopPropagation();
        const newState = enlarged.dataset.state === 'original' ? 'compressed' : 'original';
        enlarged.src = newState === 'original' ? originalSrc : compressedSrc;
        enlarged.dataset.state = newState;
      });

      // ç‚¹å‡»å…³é—­
      overlay.addEventListener('click', () => {
        overlay.remove();
        enlarged.remove();
        currentOverlay = null;
        currentEnlarged = null;
      });

      // ESCé”®å…³é—­
      document.addEventListener('keydown', function escHandler(e) {
        if (e.key === 'Escape') {
          overlay.remove();
          enlarged.remove();
          currentOverlay = null;
          currentEnlarged = null;
          document.removeEventListener('keydown', escHandler);
        }
      });

      document.body.appendChild(overlay);
      document.body.appendChild(enlarged);
    }

    async function handleFiles(files) {
      output.innerHTML = '';
      zip.files = {};
      hasShownNotification = false;
      let anyProcessed = false;
      let filesWithoutParam = 0;

      // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶æ²¡æœ‰å‚æ•°
      for (const file of files) {
        const targetSize = getTargetSizeFromName(file.name);
        if (!targetSize || isNaN(targetSize)) {
          filesWithoutParam++;
        }
      }

      // å¦‚æœæœ‰æ–‡ä»¶æ²¡æœ‰å‚æ•°ï¼Œæ˜¾ç¤ºé€šçŸ¥
      if (filesWithoutParam > 0) {
        const defaultSize = parseInt(defaultSizeInput.value);
        const message = filesWithoutParam === 1 
          ? `1ä¸ªæ–‡ä»¶æœªè¯†åˆ«åˆ°å¤§å°å‚æ•°ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼ ${defaultSize}KB è¿›è¡Œå‹ç¼©`
          : `${filesWithoutParam}ä¸ªæ–‡ä»¶æœªè¯†åˆ«åˆ°å¤§å°å‚æ•°ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼ ${defaultSize}KB è¿›è¡Œå‹ç¼©`;
        showNotification(message);
      }

      for (const file of files) {
        const row = document.createElement('div');
        row.className = 'image-row';
        output.appendChild(row);

        // åŸå§‹å›¾ç‰‡åˆ—
        const originalCol = document.createElement('div');
        originalCol.className = 'image-col';
        row.appendChild(originalCol);

        // å‹ç¼©å›¾ç‰‡åˆ—
        const compressedCol = document.createElement('div');
        compressedCol.className = 'image-col';
        row.appendChild(compressedCol);

        // ä¿¡æ¯åˆ—
        const infoCol = document.createElement('div');
        infoCol.className = 'info-col';
        row.appendChild(infoCol);

        // æ–‡ä»¶å
        const fileName = document.createElement('div');
        fileName.className = 'file-name';
        fileName.textContent = file.name;
        infoCol.appendChild(fileName);

        const targetSize = getTargetSizeFromName(file.name);
        if (!targetSize || isNaN(targetSize)) {
          const warn = document.createElement('div');
          warn.className = 'size-info';
          warn.textContent = 'âŒ æœªèƒ½ç¡®å®šç›®æ ‡å¤§å°';
          infoCol.appendChild(warn);
          continue;
        }

        const originalSrc = URL.createObjectURL(file);
        const originalPreview = createPreviewImage(originalSrc, 'original', originalSrc, originalSrc);
        originalCol.appendChild(originalPreview);

        if (file.size <= targetSize) {
          // å›¾ç‰‡å°äºç›®æ ‡å¤§å°ï¼Œä¸å‹ç¼©
          const info = document.createElement('div');
          info.className = 'size-info';
          info.textContent = `åŸå§‹å¤§å°: ${(file.size / 1024).toFixed(1)}KB\nå°äºç›®æ ‡ï¼Œè·³è¿‡å‹ç¼©`;
          infoCol.appendChild(info);

          // å‹ç¼©åˆ—æ˜¾ç¤ºåŸå§‹å›¾ç‰‡
          const compressedPreview = createPreviewImage(originalSrc, 'compressed', originalSrc, originalSrc);
          compressedCol.appendChild(compressedPreview);

          // ä¸‹è½½é“¾æ¥
          infoCol.appendChild(createDownloadLink(file, file.name));

          const arrayBuffer = await file.arrayBuffer();
          zip.file(removeParamCheckbox.checked ? getCleanFileName(file.name) : file.name, arrayBuffer);
          continue;
        }

        // éœ€è¦å‹ç¼©çš„å›¾ç‰‡
        const compressed = await compressImageToTarget(file, targetSize);
        if (compressed) {
          anyProcessed = true;
          const compressedSrc = URL.createObjectURL(compressed);

          // å‹ç¼©åå›¾ç‰‡é¢„è§ˆ
          const compressedPreview = createPreviewImage(compressedSrc, 'compressed', originalSrc, compressedSrc);
          compressedCol.appendChild(compressedPreview);

          // å¤§å°ä¿¡æ¯
          const originalSizeKB = (file.size / 1024).toFixed(1);
          const compressedSizeKB = (compressed.size / 1024).toFixed(1);
          const compressionRatio = ((1 - compressed.size / file.size) * 100).toFixed(1);
          
          const info = document.createElement('div');
          info.className = 'size-info';
          info.innerHTML = `åŸå§‹å¤§å°: ${originalSizeKB}KB<br>
                            å‹ç¼©å¤§å°: ${compressedSizeKB}KB<br>
                            å‹ç¼©ç‡: ${compressionRatio}%`;
          infoCol.appendChild(info);

          // ä¸‹è½½é“¾æ¥
          infoCol.appendChild(createDownloadLink(compressed, file.name));

          const arrayBuffer = await compressed.arrayBuffer();
          zip.file(removeParamCheckbox.checked ? getCleanFileName(file.name) : file.name, arrayBuffer);

          // æ·»åŠ é¢„è§ˆç‚¹å‡»äº‹ä»¶
          originalPreview.addEventListener('click', () => {
            showEnlargedPreview(originalSrc, originalSrc, compressedSrc, 'original');
          });

          compressedPreview.addEventListener('click', () => {
            showEnlargedPreview(compressedSrc, originalSrc, compressedSrc, 'compressed');
          });
        } else {
          const fail = document.createElement('div');
          fail.className = 'size-info';
          fail.textContent = 'âŒ å‹ç¼©å¤±è´¥';
          infoCol.appendChild(fail);
        }
      }

      if (anyProcessed) {
        const now = new Date();
        const zipName = `compressed_${now.toISOString().slice(0,19).replace(/[:T]/g,'-')}.zip`;
        const content = await zip.generateAsync({ type: "blob" });
        saveAs(content, zipName);
      }
    }

    // æ–‡ä»¶æ‹–æ”¾å¤„ç†
    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      handleFiles(Array.from(e.dataTransfer.files));
    });
    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
      handleFiles(Array.from(fileInput.files));
    });

    // ä¸»é¢˜åˆ‡æ¢é€»è¾‘
    themeToggle.addEventListener('click', () => {
      const html = document.documentElement;
      html.dataset.theme = html.dataset.theme === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', html.dataset.theme);
    });

    // åˆå§‹åŒ–ä¸»é¢˜
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      document.documentElement.dataset.theme = savedTheme;
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.dataset.theme = 'dark';
    }

    // PWA å®‰è£…æç¤º
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // æ˜¾ç¤ºè‡ªå®šä¹‰å®‰è£…æç¤º
      installContainer.style.display = 'block';
      
      // 24å°æ—¶å†…ä¸å†æ˜¾ç¤º
      const lastPromptTime = localStorage.getItem('lastPromptTime');
      if (lastPromptTime && Date.now() - lastPromptTime < 24 * 60 * 60 * 1000) {
        installContainer.style.display = 'none';
      }
    });

    installConfirm.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      
      if (outcome === 'accepted') {
        console.log('ç”¨æˆ·æ¥å—äº†å®‰è£…æç¤º');
        localStorage.setItem('lastPromptTime', Date.now());
      }
      
      deferredPrompt = null;
      installContainer.style.display = 'none';
    });

    installCancel.addEventListener('click', () => {
      installContainer.style.display = 'none';
      localStorage.setItem('lastPromptTime', Date.now());
    });

    // æ³¨å†Œ Service Worker å¹¶æ£€æŸ¥æ›´æ–°
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(registration => {
        console.log('ServiceWorker æ³¨å†ŒæˆåŠŸ:', registration.scope);
        
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          console.log('å‘ç°æ–°ç‰ˆæœ¬ ServiceWorker');
          
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              console.log('æ–°ç‰ˆæœ¬å·²å®‰è£…ï¼Œæ˜¾ç¤ºæ›´æ–°æç¤º');
              updateContainer.style.display = 'block';
            }
          });
        });
        
        // å®šæœŸæ£€æŸ¥æ›´æ–°
        setInterval(() => {
          registration.update();
        }, 60 * 60 * 1000); // æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
      }).catch(error => {
        console.log('ServiceWorker æ³¨å†Œå¤±è´¥:', error);
      });
    }

    updateRefresh.addEventListener('click', () => {
      window.location.reload();
    });

    // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„ç‰ˆæœ¬
    const savedVersion = localStorage.getItem('appVersion');
    if (savedVersion !== APP_VERSION) {
      // æ–°ç‰ˆæœ¬ï¼Œæ¸…é™¤ç¼“å­˜
      if ('caches' in window) {
        caches.keys().then(cacheNames => {
          cacheNames.forEach(cacheName => {
            caches.delete(cacheName);
          });
        });
      }
      localStorage.setItem('appVersion', APP_VERSION);
    }
  </script>
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?ed5dc7380b880499808494b9cf6f0f48";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
</body>
</html>
